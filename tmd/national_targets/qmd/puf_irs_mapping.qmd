---
output: html_document
editor_options:
  chunk_output_type: console
---

# PUF to IRS Variable Mapping

This document maps PUF (Public Use File) variables to corresponding values in IRS spreadsheets for 2015 (the PUF year) and 2022 (for comparison).

## Overview

This mapping documents the relationships between: - PUF microdata variables (2015) - IRS spreadsheet totals for 2015 - TMD (Tax Microdata) values for 2022 - IRS spreadsheet totals for 2022

The goal is to establish appropriate mappings for setting national targets based on IRS data.

Steps:

-   compare reported aggregates in IRS tables for 2015 to the documentation for 2015

```{r}
#| label: setup

# QROOT <- normalizePath(
#   file.path(getwd(), "tmd", "national_targets"),
#   winslash = "/"
# )

GITROOT <- rprojroot::find_root(rprojroot::has_file(".git/index"))
QROOT <- fs::path(GITROOT, "tmd", "national_targets", "qmd")
source(fs::path(QROOT, "setup.R"))


pufpath <- fs::path(TMDINPUT, "puf_2015.csv")

QROOT <- local({
  root <- tryCatch(quarto::get_running_project_root(), error = function(e) NULL) # non-NULL only during render
  if (!is.null(root)) {
    normalizePath(root, winslash = "/") # use Quarto’s actual project root
  } else {
    normalizePath(file.path(getwd(), "tmd", "national_targets"), winslash = "/") # interactive default
  }
})

source(fs::path(QROOT, "setup.R"))

# note - will load the functions that help with reading excel files
# also loads QROOT, DATADIR, and targfn

```

## Get data on weighted sums

### Data from PUF documentation

The following data is from the PUF documentation booklet. Tables were copied carefully into the Excel file used below and carefully supplemented. It is the most labor-intensive and error-prone part of the targets process.

Get weighted sums of numeric variables, from PUF 2015 documentation pages 46-50. The screenshot below shows what the table looks like. It includes:

-   SOI PUF 2015 variable name – e.g., first row is PUF variable E00100, Adjusted gross income

-   2015 Full SOI Individual Sample amount – this is the amount in the full (non-public-use) IRS sample (we do **not** have this data file). It is also, generally, the amount found in IRS public tables and what we should consider a control total for 2015.

-   2015 Public Use Sample amount - We generally can calculate this from the full 2015 PUF sample (as long as we include the four aggregate records).

Our detective job is to:

-   Pick an important PUF variable that we may want to target

-   Verify that it is what we think it is by summarizing the 2015 PUF and comparing to this table

-   Find its counterpart in 2015 published IRS tables so that we know which IRS table has detailed targeting information for that variable

-   Find its counterpart in 2022 published IRS tables so that we know which 2022 IRS table has detailed targeting information for that variable

![](images/paste-1.png)

```{r}

xlpath <- fs::path(DATADIR, targfn)
sheet <- "puf2015_wtdsums"
range <- "A3:E176"

mainvars <- readxl::read_excel(xlpath, sheet = sheet, range = range)

```

### PUF weighted sums, for comparison

```{r}
#| label: get-raw-puf

puf <- vroom::vroom(pufpath)

pufsums <- puf |>
  select(RECID, S006, any_of(mainvars$puf_name)) |>
  summarise(across(-c(RECID, S006), \(x) sum(x * S006 / 100))) |>
  pivot_longer(cols = everything(), names_to = "puf_name", values_to = "pufsum")


```

### Compare PUF weighted sums to

```{r}
temp <- mainvars |>
  left_join(
    pufsums |> mutate(pufsumk = pufsum / 1000) |> select(puf_name, pufsumk),
    by = join_by(puf_name)
  ) |>
  mutate(diff = pufsumk - PUF_2015, pdiff = diff / PUF_2015)

temp |>
  select(-form_location_2015) |>
  arrange(desc(abs(diff))) |>
  filter(abs(pdiff) > .01) |>
  gt() |>
  fmt_number(
    columns = c(SOI_sample_2015, PUF_2015, pufsumk, pdiff),
    decimals = 0
  ) |>
  fmt_percent(columns = pdiff, decimals = 1)

```

![](images/paste-4.png)

![](images/paste-3.png)

## Get data

```{r}

# potential targets
ptargets <- readRDS(fs::path(
  QROOT,
  "data",
  "potential_targets_preliminary.rds"
))

```

## Mapping Table 1

## Mapping Table 2

::: table-scroll
| Concept | 2015 PUF variable | 2015 PUF Sample | 2015 Full SOI | 2015 IRS Table | 2015 IRS Cell | 2015 IRS value | 2022 tmd value | 2022 IRS Table | 2022 IRS Cell | 2022 IRS value | Notes |
|------|------|------|------|------|------|------|------|------|------|------|------|
| Adjusted gross income | e00100 | 10,250.8 | 10,210.3 |  |  |  |  |  |  |  |  |
|  |  |  |  |  |  |  |  |  |  |  |  |
|  |  |  |  |  |  |  |  |  |  |  |  |
|  |  |  |  |  |  |  |  |  |  |  |  |
|  |  |  |  |  |  |  |  |  |  |  |  |
:::

## How to Edit This Table Visually

This table can be edited directly in the markdown source.

For visual editing in quarto, use ctrl-shift-F4 to toggle visual and source modes.

For easier visual editing:

### Using Markdown Table Extensions

1.  **Click inside any cell** of the table (between the `|` characters)

2.  **Open Command Palette**: Press `Ctrl+Shift+P` (Windows/Linux) or `Cmd+Shift+P` (Mac)

3.  **Type "Markdown Table"** to see available commands:

    -   "Markdown Table: Add Row Below" - Add a new row
    -   "Markdown Table: Add Column Right" - Add a new column
    -   "Markdown Table: Format Table" - Auto-format the table
    -   "Markdown Table: Delete Row" - Remove current row

4.  **Alternative: Right-click** inside a table cell to see context menu options

### Using Online Table Generator

If the extension commands don't work: 1. Go to https://www.tablesgenerator.com/markdown_tables 2. Create/edit your table visually 3. Click "Generate" to get markdown code 4. Copy and paste into this file (replace the existing table between the `::: {.table-scroll}` markers)

### Required Extensions

-   "Markdown Table" (TakumiI.markdowntable), or
-   "Markdown All in One" (yzhang.markdown-all-in-one)

## Troubleshooting Quarto "Database is Locked" Error

If you encounter a "database is locked" error when trying to render or preview this document, try these solutions in order:

1.  **Close all Quarto preview windows** - Other Quarto processes may be holding a lock

2.  **Restart Cursor/VS Code** - This will close any background Quarto processes

3.  **Wait 2-3 minutes** - Sometimes the lock clears automatically

4.  **Clear Quarto cache** (Windows):

    -   Close Cursor/VS Code
    -   Open File Explorer and navigate to: `%LOCALAPPDATA%\Quarto\`
    -   Delete the `cache` or `kv` folder if it exists
    -   Restart Cursor/VS Code

5.  **Render from command line** instead of using preview:

    ``` bash
    quarto render puf_irs_mapping.qmd
    ```

The document can still be edited even if preview doesn't work - you just won't see the rendered HTML until the lock is cleared.

```{=html}
<style>
.table-scroll {
  overflow-x: auto;
  overflow-y: visible;
  width: 100%;
  margin: 1em 0;
}

.table-scroll table {
  min-width: 100%;
  border-collapse: collapse;
}

.table-scroll table th,
.table-scroll table td {
  padding: 0.5em;
  border: 1px solid #ddd;
  white-space: nowrap;
}

.table-scroll table th {
  background-color: #f2f2f2;
  font-weight: bold;
  text-align: left;
}

/* Column width controls - adjust as needed */
.table-scroll table th:nth-child(1),
.table-scroll table td:nth-child(1) {
  width: 15%; /* Concept */
  min-width: 120px;
}

.table-scroll table th:nth-child(2),
.table-scroll table td:nth-child(2) {
  width: 10%; /* 2015 PUF variable */
  min-width: 100px;
}

.table-scroll table th:nth-child(3),
.table-scroll table td:nth-child(3) {
  width: 8%; /* 2015 PUF Sample */
  min-width: 90px;
}

.table-scroll table th:nth-child(4),
.table-scroll table td:nth-child(4) {
  width: 8%; /* 2015 Full SOI */
  min-width: 90px;
}

.table-scroll table th:nth-child(5),
.table-scroll table td:nth-child(5) {
  width: 8%; /* 2015 IRS Table */
  min-width: 80px;
}

.table-scroll table th:nth-child(6),
.table-scroll table td:nth-child(6) {
  width: 6%; /* 2015 IRS Cell */
  min-width: 70px;
}

.table-scroll table th:nth-child(7),
.table-scroll table td:nth-child(7) {
  width: 8%; /* 2015 IRS value */
  min-width: 90px;
}

.table-scroll table th:nth-child(8),
.table-scroll table td:nth-child(8) {
  width: 8%; /* 2022 tmd value */
  min-width: 90px;
}

.table-scroll table th:nth-child(9),
.table-scroll table td:nth-child(9) {
  width: 8%; /* 2022 IRS Table */
  min-width: 80px;
}

.table-scroll table th:nth-child(10),
.table-scroll table td:nth-child(10) {
  width: 6%; /* 2022 IRS Cell */
  min-width: 70px;
}

.table-scroll table th:nth-child(11),
.table-scroll table td:nth-child(11) {
  width: 8%; /* 2022 IRS value */
  min-width: 90px;
}

.table-scroll table th:nth-child(12),
.table-scroll table td:nth-child(12) {
  width: 15%; /* Notes */
  min-width: 150px;
  white-space: normal; /* Allow wrapping in notes */
}
</style>
```