---
format: html
editor_options:
  chunk_output_type: console
---

# PUF to IRS Variable Mapping

This document maps PUF (Public Use File) variables to corresponding values in IRS spreadsheets for 2015 (the PUF year) and 2022 (for comparison).

## Overview

This mapping documents the relationships between: - PUF microdata variables (2015) - IRS spreadsheet totals for 2015 - TMD (Tax Microdata) values for 2022 - IRS spreadsheet totals for 2022

The goal is to establish appropriate mappings for setting national targets based on IRS data.

Steps:

-   compare reported aggregates in IRS tables for 2015 to the documentation for 2015

```{r}
#| label: setup

GITROOT <- rprojroot::find_root(rprojroot::has_file(".git/index"))
QROOT <- fs::path(GITROOT, "tmd", "national_targets", "qmd")
source(fs::path(QROOT, "setup.R"))

pufpath <- fs::path(TMDINPUT, "puf_2015.csv")

# note - will load the functions that help with reading excel files
# also loads QROOT, DATADIR, and targfn

```

## Add target type to ptargets -- later, put in prepare.qmd

```{r}

# potential targets
ptargets1 <- readRDS(fs::path(DATADIR, "potential_targets_preliminary.rds"))
count(ptargets1, table, fname)
count(ptargets1, table)

ptargets2 <- ptargets1 |>
  mutate(
    subgroup = case_when(
      table == "tab11" ~ "all",
      table == "tab14" ~ "all",
      table == "tab12" ~ "marstat",
      table == "tab21" ~ "itemizers",
      .default = "ERROR"
    ),
    targtype = case_when(
      str_starts(vname, "nret") ~ # review this for other kinds of variables
        "number",
      .default = "amount"
    ),
    .after = datatype
  ) |>
  arrange(year, datatype, subgroup, targtype) |>
  mutate(id = row_number(), .before = 1)

glimpse(ptargets2)
skimr::skim_without_charts(ptargets2)

count(ptargets2, year, datatype, subgroup, targtype)

```

## Get data on weighted sums

### Data from PUF documentation

The following data is from the PUF documentation booklet. Tables were copied carefully into the Excel file used below and carefully supplemented. It is the most labor-intensive and error-prone part of the targets process.

Get weighted sums of numeric variables, from PUF 2015 documentation pages 46-50. The screenshot below shows what the table looks like. It includes:

-   SOI PUF 2015 variable name – e.g., first row is PUF variable E00100, Adjusted gross income

-   2015 Full SOI Individual Sample amount – this is the amount in the full (non-public-use) IRS sample (we do **not** have this data file). It is also, generally, the amount found in IRS public tables and what we should consider a control total for 2015.

-   2015 Public Use Sample amount - We generally can calculate this from the full 2015 PUF sample (as long as we include the four aggregate records).

Our detective job is to:

-   Pick an important PUF variable that we may want to target

-   Verify that it is what we think it is by summarizing the 2015 PUF and comparing to this table

-   Find its counterpart in 2015 published IRS tables so that we know which IRS table has detailed targeting information for that variable

-   Find its counterpart in 2022 published IRS tables so that we know which 2022 IRS table has detailed targeting information for that variable

![](images/paste-1.png)

```{r}

xlpath <- fs::path(DATADIR, targfn)
sheet <- "puf2015_wtdsums"
range <- "A3:E176"

mainvars <- readxl::read_excel(xlpath, sheet = sheet, range = range)

```

### PUF weighted sums, for comparison

```{r}
#| label: get-raw-puf

puf <- vroom::vroom(pufpath)

pufsums <- puf |>
  select(RECID, S006, any_of(mainvars$puf_name)) |>
  summarise(across(-c(RECID, S006), \(x) sum(x * S006 / 100))) |>
  pivot_longer(cols = everything(), names_to = "puf_name", values_to = "pufsum")

```

### Compare PUF weighted sums to those reported in PUF documentation

```{r}

tabdata <- mainvars |>
  left_join(
    pufsums |> mutate(pufsumk = pufsum / 1000) |> select(puf_name, pufsumk),
    by = join_by(puf_name)
  ) |>
  mutate(diff = pufsumk - PUF_2015, pdiff = diff / PUF_2015) |>
  select(-form_location_2015) |>
  arrange(desc(abs(diff))) |>
  mutate(row = row_number(), .before = puf_name)

tol <- 0.0001
tol_txt <- scales::label_percent(accuracy = 0.01)(tol)
nvars <- nrow(tabdata)

```

The table below compares weighted sums for variables included in puf 2015 to what the PUF documentation says to expect, where the calculated sum is different from the sum reported in the documentation by more than `{r} tol_txt`. It also shows the amount in the full SOI sample, which is the amount we would expect to find in IRS spreadsheets.

Almost all `{r} nvars` PUF variables compared are within `{r} tol_txt`. Of those that differ by more, all but one differ by approximately a factor of 10. This suggests that for these variables the IRS accidentally either (1) truncated the reported amounts by one digit, making the expected amount too low, or (2) increased the amounts on the PUF by a factor of 10, making the amounts in the data too large by a factor of 10.

```{r}

tabdata |>
  filter(abs(pdiff) > tol) |>
  gt() |>
  tab_header(
    paste0(
      "PUF 2015 weighted sums that differ from PUF 2015 documentation by more than ",
      tol_txt,
      ". Amounts in $ thousands"
    ),
    subtitle = paste0("Out of ", nvars, " variables")
  ) |>
  tab_spanner(
    "PUF 2015 documentation",
    columns = c(SOI_sample_2015, PUF_2015)
  ) |>
  cols_label(
    SOI_sample_2015 = "2015 Full SOI sample (What we should expect to find in IRS spreadsheets)",
    PUF_2015 = "2015 Public Use sample (What we should expect for calculated sum)",
    pufsumk = "Calculated weighted sum",
    diff = "Calculated minus expected",
    pdiff = "% difference from expected"
  ) |>
  fmt_number(
    columns = c(SOI_sample_2015, PUF_2015, pufsumk, pdiff),
    decimals = 0
  ) |>
  fmt_percent(columns = pdiff, decimals = 1)

```


Note that the reported full sample amounts are also off by a factor of 10. The next two tables show values in IRS tables for state and local tax deductions and for deductible interest. This makes clear that the reported full sample amounts for these variables in the PUF documentation are wrong.

Thus, we adjust the full sample amounts for these variables by a factor of 10 so that we can compare them to amounts found in IRS tables.

![](images/paste-4.png)

![](images/paste-3.png)

## Compare adjusted full-sample amounts to amounts in IRS tables


```{r}

# adjust the full-sample numbers

compdata1 <- tabdata |>
  select(row, puf_name, description, SOI_sample_2015, PUF_2015, pufsumk) |>
  mutate(
    adjust = abs(pufsumk) / abs(PUF_2015) > 9,
    mult = ifelse(is.na(adjust) | adjust, 10, 1),
    soi2015_adj = SOI_sample_2015 * mult,
    puf2015_adj = PUF_2015 * mult
  )
skimr::skim_without_charts(compdata1)
compdata1 |> filter(adjust)

compdata <- compdata1 |> select(puf_name, description, soi2015_adj, pufsumk)

```

## Compare to IRS table amounts

```{r}

comptargets <- ptargets |>
  filter(incsort == 1, year == 2015, datatype == "filers") |>
  filter(!str_detect(vname, "nret"))

tol <- 0.01
compare <- compdata |>
  mutate(lb = soi2015_adj * (1 - tol), ub = soi2015_adj * (1 + tol)) |>
  left_join(comptargets, join_by(lb <= ptarget, ub >= ptarget)) |>
  mutate(diff = ptarget - soi2015_adj, pdiff = diff / soi2015_adj) |>
  relocate(vname, .after = description) |>
  relocate(c(ptarget, diff, pdiff), .after = soi2015_adj)

compare2 <- compare |>
  filter(!is.na(ptarget)) |>
  arrange(desc(soi2015_adj), desc(abs(diff)))

```

## Go through successive rounds of identifying and saving puf-irs mappings

We map the totals records.

### Round 1: EXACT MATCH

TODO: CREATE TARGET IDNUM


```{r}
#| label: round1-explore

dtol <- 0.0
ptol <- 0.0
compare <- compdata |>
  mutate(lb = soi2015_adj * (1 - dtol), ub = soi2015_adj * (1 + dtol)) |>
  left_join(comptargets, join_by(lb <= ptarget, ub >= ptarget)) |>
  mutate(diff = ptarget - soi2015_adj, pdiff = diff / soi2015_adj) |>
  relocate(vname, .after = description) |>
  relocate(c(ptarget, diff, pdiff), .after = soi2015_adj)

compare2 <- compare |>
  filter(!is.na(ptarget)) |>
  arrange(desc(soi2015_adj), desc(abs(diff)))

comma_vars <- c("soi2015_adj", "ptarget", "diff", "pufsumk")
pct_vars <- c("pdiff")
compare2 |>
  select(puf_name:pufsumk, fname, xlcolumn, xlrownum) |>
  gt() |>
  fmt_number(columns = comma_vars, decimals = 0) |>
  fmt_percent(columns = pct_vars, decimals = 2)

```

### Round 2: Expected amounts within 0.01% of IRS