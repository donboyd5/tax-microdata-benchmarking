# PUF to IRS Variable Mapping

This document maps PUF (Public Use File) variables to corresponding values in IRS spreadsheets for 2015 (the PUF year) and 2022 (for comparison).

## Overview

This mapping documents the relationships between: - PUF microdata variables (2015) - IRS spreadsheet totals for 2015 - TMD (Tax Microdata) values for 2022 - IRS spreadsheet totals for 2022

The goal is to establish appropriate mappings for setting national targets based on IRS data.

Steps:

-   compare reported aggregates in IRS tables for 2015 to the documentation for 2015

```{r}
#| label: setup

GITROOT <- rprojroot::find_root(rprojroot::has_file(".git/index"))
QROOT <- fs::path(GITROOT, "tmd", "national_targets", "qmd")
source(fs::path(QROOT, "setup.R"))

pufpath <- fs::path(TMDINPUT, "puf_2015.csv")

# note - will load the functions that help with reading excel files
# also loads QROOT, DATADIR, and targfn

```



## Get ptargets and add target type info

Later, put in prepare.qmd

```{r}
#| label: get-potential-targets

ptargets <- readRDS(fs::path(DATADIR, "potential_targets_preliminary.rds"))

```

```{r}
#| label: ptargets-info
#| output: true

glimpse(ptargets)


skimr::skim_without_charts(ptargets)
count(ptargets, table, fname)
count(ptargets, table)
count(ptargets, year, vtype, subgroup, marstat)


```

## Begin mapping PUF variables to IRS totals

Compare full-sample totals for PUF variables to IRS totals

```{r}
#| output: false

count(ptargets, table, fname)
count(ptargets, vtype)
count(ptargets, subgroup)
count(ptargets, marstat)

comptargets <- ptargets |>
  filter(
    year == 2015,
    vtype == "amount",
    subgroup %in% c("filers"),
    marstat == "all",
    incsort == 1
  )

```

### Round 1: EXACT MATCH

Start by finding exact matches between expected IRS totals (soi2015_adj) and actual IRS totals pulled from spreadsheets.

```{r}
#| label: round1-explore

comma_vars <- c("soifull2015_adj", "ptarget", "diff", "pufsumk")
pct_vars <- c("pdiff")

# dtol <- 0.0
ptol <- 0.0
compare1 <- puf_compare2 |>
  mutate(
    lb = soifull2015_adj * (1 - ptol),
    ub = soifull2015_adj * (1 + ptol)
  ) |>
  left_join(comptargets, join_by(lb <= ptarget, ub >= ptarget)) |>
  filter(!is.na(ptarget)) |>
  mutate(diff = ptarget - soifull2015_adj, pdiff = diff / soifull2015_adj) |>
  select(
    pufdocrow,
    puf_name,
    description,
    vname,
    vdescription,
    soifull2015_adj,
    ptarget,
    diff,
    pdiff,
    everything()
  ) |>
  arrange(desc(soifull2015_adj), desc(abs(diff)))

# inspection shows duplicates:
#    tab12-2015-exemption-amount-filers-all
#    tab14-2015-exemption-amount-filers-all
#  let's drop the tab14 version for now

```

```{r}
#| label: show-round1
#| output: true

# compare1 |>
#   select(
#     idbase,
#     puf_name:pufsumk,
#     table,
#     datatype,
#     subgroup,
#     targtype,
#     fname,
#     xlcolumn,
#     xlrownum
#   ) |>
#   gt() |>
#   tab_header("Round 1 exact match results") |>
#   fmt_number(columns = comma_vars, decimals = 0) |>
#   fmt_percent(columns = pct_vars, decimals = 2)

```

Duplicate matches

```{r}
#| output: true

compare1 |>
  select(
    targetid,
    puf_name:pufsumk,
    table,
    datatype,
    subgroup,
    targtype,
    fname,
    xlcolumn,
    xlrownum
  ) |>
  mutate(n = n(), .by = puf_name) |>
  filter(n > 1) |>
  gt() |>
  tab_header(
    "Round 1 duplicates where puf variable has more than 1 exact matches"
  ) |>
  fmt_number(columns = comma_vars, decimals = 0) |>
  fmt_percent(columns = pct_vars, decimals = 2)

```

Get unique round1 results

```{r}

round1 <- compare1 |> filter(!targetid == 1)


```

### Round 2: Near-exact matches (expected amounts within 0.1% of IRS)

```{r}

ptol <- 0.001
compare2 <- compdata |>
  filter(!puf_name %in% round1$puf_name) |>
  mutate(lb = soi2015_adj * (1 - ptol), ub = soi2015_adj * (1 + ptol)) |>
  left_join(comptargets, join_by(lb <= ptarget, ub >= ptarget)) |>
  filter(!is.na(ptarget)) |>
  mutate(diff = ptarget - soi2015_adj, pdiff = diff / soi2015_adj) |>
  relocate(vname, .after = description) |>
  relocate(c(ptarget, diff, pdiff), .after = soi2015_adj) |>
  arrange(desc(soi2015_adj), desc(abs(diff)))

```


```{r}
#| label: show-round2
#| output: true

compare2 |>
  select(
    targetid,
    puf_name:pufsumk,
    table,
    datatype,
    subgroup,
    targtype,
    fname,
    xlcolumn,
    xlrownum
  ) |>
  gt() |>
  tab_header("Round 2 near-exact match results") |>
  fmt_number(columns = comma_vars, decimals = 0) |>
  fmt_percent(columns = pct_vars, decimals = 2)

```

There are 3 extremely close matches. The only one that appears valid is E01500 and pensions, which have the same basic name and are within \$1. The others are not matches.

```{r}

# it's obvious there are no dups
round2 <- compare2 |> filter(puf_name == "E01500")

```


### Round 3: Close matches (expected amounts within 1% of IRS)


```{r}

ptol <- 0.01
compare3 <- compdata |>
  filter(!puf_name %in% c(round1$puf_name, round2$puf_name)) |>
  mutate(lb = soi2015_adj * (1 - ptol), ub = soi2015_adj * (1 + ptol)) |>
  left_join(comptargets, join_by(lb <= ptarget, ub >= ptarget)) |>
  filter(!is.na(ptarget)) |>
  mutate(diff = ptarget - soi2015_adj, pdiff = diff / soi2015_adj) |>
  relocate(vname, .after = description) |>
  relocate(c(ptarget, diff, pdiff), .after = soi2015_adj) |>
  arrange(desc(soi2015_adj), desc(abs(diff)))

# which if any of these targets were NOT already used in round 1 or round 2

compare3a <- compare3 |>
  filter(!targetid %in% c(round1$targetid, round2$targetid))

```


Round 3 is a bust:

- Only 6 IRS targets were found that were not previously paired with an expected total
- Based on variable descriptions, NONE was a good match.

```{r}

amount_matches <- bind_rows(round1, round2)

amount_matches |>
  select(
    targetid,
    puf_name:pufsumk,
    table,
    datatype,
    subgroup,
    targtype,
    fname,
    xlcolumn,
    xlrownum
  ) |>
  gt() |>
  tab_header("Good matches for amount variables after 3 rounds") |>
  fmt_number(columns = comma_vars, decimals = 0) |>
  fmt_percent(columns = pct_vars, decimals = 2)

```
