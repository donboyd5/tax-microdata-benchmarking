"""
Test 2026 tax benefits generated by the new OBBBA deductions using tmd
files that include imputed values for overtime_income, tip_income, and
auto_loan_interest.
"""

import numpy as np
import pytest
import taxcalc as tc


def test_obbba_deduction_tax_benefits(
    tmd_variables_path,
    tmd_weights_path,
    tmd_growfactors_path,
):
    """
    Estimate percent of tax-units affected by each new tax deduction and
    average size of the 2026 dollar effect among those affected.
    """

    def actual_results(rdf, bdf):
        """
        Returns dictionary of results based on rdf and bdf dataframes.
        """
        res = {}
        weight = bdf["s006"].to_numpy()
        dedben = rdf["iitax"].to_numpy() - bdf["iitax"].to_numpy()
        res["totben"] = round(((weight * dedben).sum() * 1e-9), 2)
        affected = dedben > 0
        tot_weight = weight.sum()
        aff_weight = (affected * weight).sum()
        res["affpct"] = round((100 * aff_weight / tot_weight), 2)
        avg_ben = (affected * dedben * weight).sum() / aff_weight
        res["affben"] = round(avg_ben, 0)
        return res

    # begin main logic of test function
    simyear = 2026
    # specify aspects of each new OBBBA tax deduction
    deductions = {
        "OTM": {  # new OBBBA overtime income deduction
            "reform_dict": {"OvertimeIncomeDed_c": {simyear: [0, 0, 0, 0, 0]}},
            "exp_totben": 23.93,
            "exp_affpct": 8.85,
            "exp_affben": 1407,
            # The OTM imputation calibration parameters used in the
            # create_taxcalc_imputed_variables.py module were
            # specified so that the affpct statistic is close to 8.8%
            # and the affben statistic is close to $1400, which are
            # the OTM results reported by the Tax Policy Center
            # https://taxpolicycenter.org/taxvox/
            #         budget-laws-tax-cuts-overtime-and-
            #         tips-are-popular-few-will-benefit
        },
        "TIP": {  # new OBBBA tip income deduction
            "reform_dict": {"TipIncomeDed_c": {simyear: 0}},
            "exp_totben": 7.05,
            "exp_affpct": 2.59,
            "exp_affben": 1416,
            # The TIP imputation calibration parameters used in the
            # create_taxcalc_imputed_variables.py module were
            # specified so that the affpct statistic is close to 2.6%
            # and the affben statistic is close to $1400, which are
            # the TIP results reported by the Tax Policy Center
            # https://taxpolicycenter.org/taxvox/
            #         budget-laws-tax-cuts-overtime-and-
            #         tips-are-popular-few-will-benefit
        },
        "ALI": {  # new OBBBA auto loan interest deduction
            "reform_dict": {"AutoLoanInterestDed_c": {simyear: 0}},
            "exp_totben": 1.72,
            "exp_affpct": 10.27,
            "exp_affben": 87,
            # The ALI imputation calibration parameters used in the
            # create_taxcalc_imputed_variables.py module do not
            # adjust the MICE-imputed values of auto_loan_interest
            # because the Tax Policy Center did not provide any
            # statistics for this new deduction.  However, see the
            # following FOUR reform analysis.
        },
        "ALL": {  # above three deductions plus new OBBBA senior deduction
            "reform_dict": {
                "OvertimeIncomeDed_c": {simyear: [0, 0, 0, 0, 0]},
                "TipIncomeDed_c": {simyear: 0},
                "AutoLoanInterestDed_c": {simyear: 0},
                "SeniorDed_c": {simyear: 0},
            },
            "exp_totben": 55.14,
            "exp_affpct": 28.08,
            "exp_affben": 1022,
            # The affpct statistic of 28.08% and the affben statistic
            # of $1022 are reasonably close to the Tax Policy Center
            # estimates of 29.6% and $1081, respectively, as reported at
            # https://taxpolicycenter.org/model-estimates/T25-0257
            # Note that the $1081 TPC estimate is derived by dividing
            # the all-unit average of $320 by the 0.296 affpct.
        },
    }
    output_variables = [
        "s006",  # weight
        "iitax",  # income tax liability
    ]
    # create Tax-Calculator Records object
    recs = tc.Records.tmd_constructor(
        tmd_variables_path,
        tmd_weights_path,
        tmd_growfactors_path,
        exact_calculations=True,
    )
    # create baseline_sim Calculator object for simyear and get its output
    baseline_sim = tc.Calculator(policy=tc.Policy(), records=recs)
    baseline_sim.advance_to_year(simyear)
    baseline_sim.calc_all()
    bdf = baseline_sim.dataframe(output_variables)
    # estimate effects of each new OBBBA deduction
    diffs = []  # list of act-vs-exp differences
    for ded, info in deductions.items():
        # create reform Calculator object for simyear
        reform_policy = tc.Policy()
        reform_policy.implement_reform(info["reform_dict"])
        reform_sim = tc.Calculator(policy=reform_policy, records=recs)
        reform_sim.advance_to_year(simyear)
        # get reform Calculator object's output
        reform_sim.calc_all()
        rdf = reform_sim.dataframe(output_variables)
        # tabulate act results
        act_res = actual_results(rdf, bdf)
        # compare act results with exp results for each statistic
        tolerance = {
            "totben": {"abs": 0.02, "rel": 0.0015},
            "affpct": {"abs": 0.01, "rel": 0.0005},
            "affben": {"abs": 1.00, "rel": 0.0000},
        }
        for stat in ["totben", "affpct", "affben"]:
            act = act_res[stat]
            exp = info[f"exp_{stat}"]
            a_tol = tolerance[stat]["abs"]
            r_tol = tolerance[stat]["rel"]
            if not np.allclose([act], [exp], atol=a_tol, rtol=r_tol):
                diff = (
                    f"DIFF:{ded},{stat},act,exp,atol,rtol= "
                    f"{act} {exp} {a_tol} {r_tol}"
                )
                diffs.append(diff)
        # delete reform Policy and Calculator objects
        del reform_policy
        del reform_sim
    if diffs:
        emsg = "\nIMPUTED VARIABLE DEDUCTION BENEFIT ACT-vs-EXP DIFFS:"
        for line in diffs:
            emsg += "\n" + line
        raise ValueError(emsg)


@pytest.mark.imputed_distribution
def test_imputed_variable_distribution(tmd_variables):
    """
    Calculate distribution of TMD imputed variables.
    """
    imputed_var_names = ["overtime_income", "tip_income", "auto_loan_interest"]
    expect = {
        "overtime_income": {"mean": 10_843, "sdev": 258_993},
        "tip_income": {"mean": 1_909, "sdev": 104_687},
        "auto_loan_interest": {"mean": 116, "sdev": 352},
    }
    tolerance = {
        "overtime_income": 0.001,
        "tip_income": 0.001,
        "auto_loan_interest": 0.007,
    }
    diffs = []
    for ivname in imputed_var_names:
        assert (
            ivname in tmd_variables.columns
        ), f"Column {ivname} missing from tmd.csv.gz"
        varray = tmd_variables[ivname].to_numpy()
        actual = {"mean": varray.mean(), "sdev": varray.std()}
        for stat in ["mean", "sdev"]:
            act = actual[stat]
            exp = expect[ivname][stat]
            abstol = 0.0
            reltol = tolerance[ivname]
            if not np.allclose([act], [exp], atol=abstol, rtol=reltol):
                diff = (
                    f"IMPUTED_VAR_DIFF:{ivname},{stat},act,exp,atol,rtol= "
                    f"{act} {exp} {abstol} {reltol}"
                )
                diffs.append(diff)
    if diffs:
        emsg = "\nIMPUTED VARIABLE DISTRIBUTION ACT-vs-EXP DIFFS:"
        for line in diffs:
            emsg += "\n" + line
        raise ValueError(emsg)
